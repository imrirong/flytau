{#
  manage_flights.html

  Multi-step manager page for creating a new flight:
  1) Select route + departure date/time and check aircraft availability.
  2) Choose an available aircraft for the selected route/time.
  3) Enter prices and assign the required crew (pilots and attendants), then submit to create the flight.
#}

{% extends "layout.html" %}

{% block title %}ניהול טיסות - FLYTAU{% endblock %}

{% block content %}
<div class="container">
  <div class="row justify-content-center">
      <div class="col-lg-8">
          <div class="card shadow">
              <div class="card-header bg-primary text-white text-center">
                  <h1 class="h4 mb-0">הוספת טיסה חדשה</h1>
              </div>

              <div class="card-body">
                  {% if step == 1 %}
                  <form action="{{ url_for('add_flight') }}" method="POST">
                      <input type="hidden" name="step" value="check_availability">

                      <div class="mb-3">
                          <label class="form-label" for="route_id">בחר מסלול (Route):</label>
                          <select id="route_id" name="route_id" class="form-select" required>
                              {% for r in routes %}
                              <option value="{{ r.route_id }}">{{ r.origin }} -> {{ r.destination }} ({{ r.duration }} דקות)</option>
                              {% endfor %}
                          </select>
                      </div>

                      <div class="row">
                          <div class="col-md-6 mb-3">
                              <label class="form-label" for="date">תאריך המראה:</label>
                              <input id="date" type="date" name="date" class="form-control" min="{{ min_date }}" required>
                          </div>
                          <div class="col-md-6 mb-3">
                              <label class="form-label" for="time">שעת המראה:</label>
                              <input id="time" type="time" name="time" class="form-control" required>
                          </div>
                      </div>

                      <button type="submit" class="btn btn-primary w-100 fw-bold">בדוק זמינות מטוסים</button>
                  </form>

                  {% elif step == 2 %}
                  <h2 class="h5 mb-3">בחר מטוס זמין:</h2>
                  <form action="{{ url_for('add_flight') }}" method="POST">
                      <input type="hidden" name="step" value="assign_crew">
                      <input type="hidden" name="route_id" value="{{ route_id }}">
                      <input type="hidden" name="date" value="{{ date }}">
                      <input type="hidden" name="time" value="{{ time }}">

                      <div class="list-group mb-4">
                          {% if aircrafts %}
                              {% for a in aircrafts %}
                              <label class="list-group-item d-flex justify-content-between align-items-center">
                                  <div>
                                      <input class="form-check-input ms-2" type="radio" name="aircraft_id" value="{{ a.aircraft_id }}" required>
                                      <strong>{{ a.manufacturer }}</strong> (ID: {{ a.aircraft_id }})
                                  </div>
                                  <span class="badge bg-secondary">{{ a.size }}</span>
                              </label>
                              {% endfor %}
                          {% else %}
                              <div class="alert alert-danger mb-3">אין מטוסים זמינים למסלול ולזמן שנבחרו.</div>
                              <a href="{{ url_for('add_flight') }}" class="btn btn-outline-secondary">חזרה</a>
                          {% endif %}
                      </div>

                      {% if aircrafts %}
                      <button type="submit" class="btn btn-success w-100 fw-bold">המשך לשיבוץ צוות</button>
                      {% endif %}
                  </form>

                  {% elif step == 3 %}
                  <form action="{{ url_for('add_flight') }}" method="POST">
                      <h2 class="h5 mb-3">פרטי טיסה סופיים</h2>

                      <input type="hidden" name="step" value="create">
                      <input type="hidden" name="route_id" value="{{ route_id }}">
                      <input type="hidden" name="date" value="{{ date }}">
                      <input type="hidden" name="time" value="{{ time }}">
                      <input type="hidden" name="aircraft_id" value="{{ aircraft.aircraft_id }}">

                      <div class="row mb-4">
                          <div class="col-md-6">
                              <label class="form-label" for="price_eco">מחיר מחלקת תיירים :</label>
                              <input id="price_eco" type="number" name="price_eco" class="form-control" min="1" required>
                          </div>

                          {% if aircraft.size != 'Small' %}
                          <div class="col-md-6">
                              <label class="form-label" for="price_bus">מחיר מחלקת עסקים (Business):</label>
                              <input id="price_bus" type="number" name="price_bus" class="form-control" min="1" required>
                          </div>
                          {% else %}
                          <div class="col-md-6">
                              <label class="form-label text-muted">מחיר מחלקת עסקים:</label>
                              <input type="text" class="form-control" value="לא זמין במטוס זה" disabled>
                              <input type="hidden" name="price_bus" value="0">
                          </div>
                          {% endif %}
                      </div>

                      <h3 class="h6 text-primary fw-bold">בחר {{ req_pilots }} טייסים זמינים:</h3>
                      <div class="mb-4 p-2 border rounded-3" style="max-height: 220px; overflow-y: auto;">
                          {% for p in pilots %}
                          <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="pilots" value="{{ p.employee_id }}" id="pilot_{{ p.employee_id }}">
                              <label class="form-check-label" for="pilot_{{ p.employee_id }}">{{ p.first_name }} {{ p.last_name }} (ID: {{ p.employee_id }})</label>
                          </div>
                          {% endfor %}
                      </div>

                      <h3 class="h6 text-primary fw-bold">בחר {{ req_attendants }} דיילים זמינים:</h3>
                      <div class="mb-4 p-2 border rounded-3" style="max-height: 220px; overflow-y: auto;">
                          {% for a in attendants %}
                          <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="attendants" value="{{ a.employee_id }}" id="att_{{ a.employee_id }}">
                              <label class="form-check-label" for="att_{{ a.employee_id }}">{{ a.first_name }} {{ a.last_name }} (ID: {{ a.employee_id }})</label>
                          </div>
                          {% endfor %}
                      </div>

                      <button type="submit" class="btn btn-primary w-100 fw-bold">צור טיסה</button>
                  </form>
                  {% endif %}
              </div>
          </div>
      </div>
  </div>
</div>
{% endblock %}
