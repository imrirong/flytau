{% extends "layout.html" %}
{% block title %}אישור הזמנה ותשלום - FLYTAU{% endblock %}

{% block content %}
<div class="container mt-4" dir="rtl">
  <div class="row g-4">

    <!-- פרטי טיסה + סיכום מושבים -->
    <div class="col-lg-5">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white text-end">
          סיכום הזמנה
        </div>
        <div class="card-body text-end">
          <p><strong>מסלול:</strong> {{ flight.origin }} → {{ flight.destination }}</p>
          <p><strong>תאריך:</strong> {{ flight.departure_date }}</p>
          <p><strong>שעת המראה:</strong> {{ flight.departure_time }}</p>
          <p><strong>משך הטיסה:</strong> {{ flight.route_duration }} דקות</p>

          <hr>

          <p class="fw-bold mb-2">מושבים שנבחרו:</p>
          <ul class="mb-3">
            {% for s in data.seats_info %}
              <li dir="ltr">{{ s.row }}{{ s.col }} ({{ s.seat_class }}) — {{ s.price }}₪</li>
            {% endfor %}
          </ul>

          <div class="alert alert-success fw-bold text-end mb-0">
            סה"כ לתשלום: {{ "%.2f"|format(data.total_price) }}₪
          </div>
        </div>
      </div>
    </div>

    <!-- פרטי מזמין + תשלום -->
    <div class="col-lg-7">
      <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white text-end">
          פרטי מזמין ואישור תשלום
        </div>
        <div class="card-body text-end">

          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, message in messages %}
                <div class="alert alert-{{ category if category != 'error' else 'danger' }} mb-3">
                  {{ message }}
                </div>
              {% endfor %}
            {% endif %}
          {% endwith %}

          <form method="POST" id="confirmForm">

            {% if not session.get('user_id') %}
              <div class="alert alert-info">
                כדי להשלים הזמנה כאורח, מלא/י פרטים והוסף/י לפחות מספר טלפון אחד.
              </div>

              <div class="mb-3">
                <label class="form-label fw-bold">אימייל</label>
                <input type="email" name="email" class="form-control" required>
              </div>

              <div class="row g-2 mb-3">
                <div class="col-md-6">
                  <label class="form-label fw-bold">שם פרטי(באנגלית)</label>
                  <input type="text"
       name="first_name"
       class="form-control"
       required
       pattern="[A-Za-z\s\-']+"
       title="באנגלית בלבד">

                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold">שם משפחה (באנגלית)</label>
                  <input type="text"
       name="last_name"
       class="form-control"
       required
       pattern="[A-Za-z\s\-']+"
       title="באנגלית">

                </div>
              </div>

              <div class="mb-2">
                <label class="form-label fw-bold">טלפונים (חובה לפחות אחד)</label>
                <div id="phonesWrap" class="d-grid gap-2">
                  <input type="text" name="phones" class="form-control" placeholder="0501234567" required>
                </div>

                <div class="d-flex gap-2 mt-2">
                  <button type="button" class="btn btn-outline-primary btn-sm" onclick="addPhone()">
                    הוסף טלפון
                  </button>
                  <button type="button" class="btn btn-outline-danger btn-sm" onclick="removePhone()">
                    הסר טלפון
                  </button>
                </div>
              </div>
            {% else %}
              <div class="alert alert-info">
                את/ה מחובר/ת — נדרש רק לאשר את התשלום.
              </div>
            {% endif %}

            <hr>


            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="agree" required>
              <label class="form-check-label" for="agree">
                אני מאשר/ת את פרטי ההזמנה והתשלום
              </label>
            </div>

            <button type="submit" class="btn btn-success w-100 fw-bold">
              אשר תשלום והזמן
            </button>
          </form>

          <script>
            function addPhone() {
              const wrap = document.getElementById("phonesWrap");
              const input = document.createElement("input");
              input.type = "text";
              input.name = "phones";
              input.className = "form-control";
              input.placeholder = "טלפון נוסף";
              wrap.appendChild(input);
            }

            function removePhone() {
              const wrap = document.getElementById("phonesWrap");
              const inputs = wrap.querySelectorAll("input[name='phones']");
              if (inputs.length > 1) {
                inputs[inputs.length - 1].remove();
              }
            }
          </script>

        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}
